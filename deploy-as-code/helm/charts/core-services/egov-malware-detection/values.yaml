# Common Labels
labels:
  app: "egov-malware-detection"
  group: "core"

# Init Containers Configs
initContainers:
  dbMigration:
    enabled: true
    schemaTable: "egov_malware_schema"
    image:
      repository: "egov-malware-detection-db"

# Ingress Configs
ingress:
  zuul: true
  context: "malware-detection"

# Container Configs
image:
  repository: "egov-malware-detection"
replicas: "1"
healthChecks:
  enabled: true
  livenessProbePath: "/malware-detection/health"
  readinessProbePath: "/malware-detection/health"
appType: "java-spring"
tracing-enabled: true
heap: "-Xmx512m -Xms512m"
memory_limits: "768Mi"
cpu_limits: "500m"

# =============================================================================
# ClamAV Configuration
# =============================================================================
clamav-host: "clamav.security"
clamav-port: "3310"
clamav-timeout: "60000"
clamav-chunk-size: "2048"

# =============================================================================
# S3/MinIO Configuration (uses same credentials as egov-filestore)
# =============================================================================
# When is-s3-enabled=true and minio-enabled=false: Uses AWS S3 with egov-filestore secret
# When minio-enabled=true: Uses MinIO with minio secret
is-s3-enabled: true
minio-enabled: false
fixed-bucketname: "egov-rainmaker"
fixed-bucket-region: "ap-south-1"
quarantine-bucketname: "egov-quarantine"

# =============================================================================
# Notification Configuration
# =============================================================================
# Slack Configuration (optional - set slack-enabled to false to disable)
slack-enabled: true
# slack-webhook-url: Fetched from secret 'egov-malware-detection' key 'slack-webhook-url'
slack-channel: "#security-alerts"
slack-username: "MalwareBot"
slack-icon-emoji: ":warning:"

# Email Configuration
mail-enabled: true
mail-notification-mode: "kafka"  # "direct" or "kafka"
# mail-alert-recipients: Fetched from secret 'egov-malware-detection' key 'mail-alert-recipients'
#                        Falls back to env variable if secret key doesn't exist
mail-alert-recipients: ""  # Fallback value if secret is not set (comma-separated email addresses)
mail-alert-subject: "DIGIT Security Alert"

# =============================================================================
# Kafka Topics Configuration
# =============================================================================
kafka-topics-malware-scan-request: "egov.malware.file-scan-request"
kafka-topics-malware-scan-result: "egov.malware.scan-completed"
kafka-topics-malware-scan-save: "egov.malware.persist-scan-result"
kafka-topics-notification-email: "egov.core.notification.email"

# =============================================================================
# Scan Settings
# =============================================================================
scan-max-file-size-mb: "50"

# =============================================================================
# Quarantine Settings
# =============================================================================
quarantine-enabled: true
quarantine-delete-original: true

# =============================================================================
# Additional Container Envs
# =============================================================================
env: |
  - name: SERVER_PORT
    value: "8080"
  - name: SERVER_CONTEXTPATH
    value: "/malware-detection"
  - name: JAVA_OPTS
    value: {{ index .Values "heap" | quote }}
  - name: SECURITY_BASIC_ENABLED
    value: "false"
  - name: MANAGEMENT_SECURITY_ENABLED
    value: "false"
  {{- if index .Values "tracing-enabled" }}
  - name: TRACER_OPENTRACING_ENABLED
    value: "true"
  {{- end }}
  - name: SPRING_DATASOURCE_URL
    valueFrom:
      configMapKeyRef:
        name: egov-config
        key: db-url
  - name: SPRING_DATASOURCE_USERNAME
    valueFrom:
      secretKeyRef:
        name: db
        key: username
  - name: SPRING_DATASOURCE_PASSWORD
    valueFrom:
      secretKeyRef:
        name: db
        key: password
  - name: SPRING_FLYWAY_USER
    valueFrom:
      secretKeyRef:
        name: db
        key: username
  - name: SPRING_FLYWAY_PASSWORD
    valueFrom:
      secretKeyRef:
        name: db
        key: password
  - name: CLAMAV_HOST
    value: {{ index .Values "clamav-host" | quote }}
  - name: CLAMAV_PORT
    value: {{ index .Values "clamav-port" | quote }}
  - name: CLAMAV_TIMEOUT
    value: {{ index .Values "clamav-timeout" | quote }}
  - name: CLAMAV_CHUNK_SIZE
    value: {{ index .Values "clamav-chunk-size" | quote }}
  {{- if index .Values "is-s3-enabled" }}
  - name: ISS3ENABLED
    value: "true"
  {{- end }}
  {{- if index .Values "minio-enabled" }}
  - name: MINIO_URL
    valueFrom:
      configMapKeyRef:
        name: egov-service-host
        key: minio-url
  - name: AWS_KEY
    valueFrom:
      secretKeyRef:
        name: minio
        key: accesskey
  - name: AWS_SECRETKEY
    valueFrom:
      secretKeyRef:
        name: minio
        key: secretkey
  {{- else }}
  - name: MINIO_URL
    value: "https://s3.{{ index .Values "fixed-bucket-region" }}.amazonaws.com"
  - name: AWS_KEY
    valueFrom:
      secretKeyRef:
        name: egov-filestore
        key: awskey
  - name: AWS_SECRETKEY
    valueFrom:
      secretKeyRef:
        name: egov-filestore
        key: awssecretkey
  {{- end }}
  - name: FIXED_BUCKETNAME
    value: {{ index .Values "fixed-bucketname" | quote }}
  - name: FIXED_BUCKET_REGION
    value: {{ index .Values "fixed-bucket-region" | quote }}
  - name: QUARANTINE_BUCKETNAME
    value: {{ index .Values "quarantine-bucketname" | quote }}
  - name: MINIO_SOURCE
    value: "minio"
  - name: EGOV_FILESTORE_HOST
    valueFrom:
      configMapKeyRef:
        name: egov-service-host
        key: egov-filestore
  - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
    valueFrom:
      configMapKeyRef:
        name: egov-config
        key: kafka-brokers
  - name: SPRING_KAFKA_CONSUMER_GROUP_ID
    value: "malware-detection-group"
  - name: KAFKA_TOPICS_MALWARE_SCAN_REQUEST
    value: {{ index .Values "kafka-topics-malware-scan-request" | quote }}
  - name: KAFKA_TOPICS_MALWARE_SCAN_RESULT
    value: {{ index .Values "kafka-topics-malware-scan-result" | quote }}
  - name: KAFKA_TOPICS_MALWARE_SCAN_SAVE
    value: {{ index .Values "kafka-topics-malware-scan-save" | quote }}
  - name: KAFKA_TOPICS_NOTIFICATION_EMAIL
    value: {{ index .Values "kafka-topics-notification-email" | quote }}
  - name: SLACK_WEBHOOK_ENABLED
    value: {{ index .Values "slack-enabled" | quote }}
  {{- if index .Values "slack-enabled" }}
  - name: SLACK_WEBHOOK_URL
    valueFrom:
      secretKeyRef:
        name: egov-malware-detection
        key: slack-webhook-url
  - name: SLACK_CHANNEL
    value: {{ index .Values "slack-channel" | quote }}
  - name: SLACK_USERNAME
    value: {{ index .Values "slack-username" | quote }}
  - name: SLACK_ICON_EMOJI
    value: {{ index .Values "slack-icon-emoji" | quote }}
  {{- end }}
  - name: MAIL_ENABLED
    value: {{ index .Values "mail-enabled" | quote }}
  - name: MAIL_NOTIFICATION_MODE
    value: {{ index .Values "mail-notification-mode" | quote }}
  - name: MAIL_ALERT_SUBJECT
    value: {{ index .Values "mail-alert-subject" | quote }}
  {{- if index .Values "mail-alert-recipients" }}
  - name: MAIL_ALERT_RECIPIENTS
    value: {{ index .Values "mail-alert-recipients" | quote }}
  {{- else }}
  - name: MAIL_ALERT_RECIPIENTS
    valueFrom:
      secretKeyRef:
        name: egov-malware-detection
        key: mail-alert-recipients
        optional: true
  {{- end }}
  {{- if eq (index .Values "mail-notification-mode") "direct" }}
  - name: MAIL_HOST
    value: "smtp.gmail.com"
  - name: MAIL_PORT
    value: "465"
  - name: MAIL_PROTOCOL
    value: "smtps"
  - name: MAIL_SENDER_USERNAME
    valueFrom:
      secretKeyRef:
        name: egov-notification-mail
        key: mailsenderusername
  - name: MAIL_SENDER_PASSWORD
    valueFrom:
      secretKeyRef:
        name: egov-notification-mail
        key: mailsenderpassword
  {{- end }}
  - name: SCAN_MAX_FILE_SIZE_MB
    value: {{ index .Values "scan-max-file-size-mb" | quote }}
  - name: QUARANTINE_ENABLED
    value: {{ index .Values "quarantine-enabled" | quote }}
  - name: QUARANTINE_DELETE_ORIGINAL
    value: {{ index .Values "quarantine-delete-original" | quote }}
  - name: EGOV_STATE_TENANT_ID
    valueFrom:
      configMapKeyRef:
        name: egov-config
        key: egov-state-level-tenant-id
